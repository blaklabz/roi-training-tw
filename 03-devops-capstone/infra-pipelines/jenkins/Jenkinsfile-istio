pipeline {
  agent any

  environment {
    AWS_DEFAULT_REGION = 'us-east-2'
    CLUSTER_NAME = 'cluster2-tw'
    ISTIO_VERSION = '1.22.0'
    ISTIOCTL = "${env.WORKSPACE}/istio-${ISTIO_VERSION}/bin/istioctl"
    KUBECONFIG_PATH = "${env.WORKSPACE}/kubeconfig"
  }

  stages {
    stage('Checkout') {
      steps {
        checkout scm
      }
    }

    stage('Configure AWS and Connect to EKS') {
      steps {
        withCredentials([[
          $class: 'AmazonWebServicesCredentialsBinding',
          credentialsId: 'aws-credentials',
          accessKeyVariable: 'AWS_ACCESS_KEY_ID',
          secretKeyVariable: 'AWS_SECRET_ACCESS_KEY'
        ]]) {
          sh """
            aws eks update-kubeconfig \
              --region $AWS_DEFAULT_REGION \
              --name $CLUSTER_NAME \
              --kubeconfig $KUBECONFIG_PATH

            # Embed a valid token in kubeconfig so istioctl works
            TOKEN=$(aws eks get-token --region $AWS_DEFAULT_REGION --cluster-name $CLUSTER_NAME --output json | jq -r .status.token)
            CONTEXT_NAME=$(kubectl --kubeconfig=$KUBECONFIG_PATH config current-context)
            kubectl --kubeconfig=$KUBECONFIG_PATH config set-credentials eks-user --token="$TOKEN"
            kubectl --kubeconfig=$KUBECONFIG_PATH config set-context "$CONTEXT_NAME" --user=eks-user
          """
        }
      }
    }

    stage('Download istioctl') {
      steps {
        sh """
          curl -L https://istio.io/downloadIstio | ISTIO_VERSION=$ISTIO_VERSION sh -
        """
      }
    }

    stage('Install Istio Base & Default Profile') {
      steps {
        sh """
          export KUBECONFIG=$KUBECONFIG_PATH
          $ISTIOCTL install --set profile=default -y
        """
      }
    }

    stage('Label Default Namespace for Istio Injection') {
      steps {
        sh """
          export KUBECONFIG=$KUBECONFIG_PATH
          kubectl label namespace default istio-injection=enabled --overwrite
        """
      }
    }
  }
}
